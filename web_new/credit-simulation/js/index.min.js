function initializeSelect2(target, placeholder) {
  target.select2({ placeholder: placeholder });
}
$("[id^=select2]").each(function (index, target) {
  target = $(target);
  initializeSelect2(target, target.data("holder"));
});
function parseURL(url) {
  let result = {},
    seg = url.slice(1).split("&"),
    len = seg.length,
    i = 0,
    s;
  for (; i < len; i++) {
    if (!seg[i]) {
      continue;
    }
    s = seg[i].split("=");
    result[s[0]] = decodeURIComponent(s[1]);
  }
  return result;
}
var params = parseURL(location.search.replaceAll(/\+/g, "%20"));
var $select21 = $("#select2-1");
var $select22 = $("#select2-2");
var $select23 = $("#select-2-3");
var $select23_holder = $("#select-2-3-holder");
var $select_section = $(".select-section");
$.ajax({
  url: "/ajax/com/product/getprice",
  type: "POST",
  dataType: "json",
  success: function (data) {
    for (let i = 0; i < data.length; i++) {
      $select21.append(`<option value="${data[i].id}">${data[i].product_name}</option>`);
    }
    if (JSON.stringify(params) !== "{}") {
      var $select21_select2 = $select21.select2();
      $select21_select2.val(params.model).trigger("change");
    }
  },
});
function getProduct(product_id) {
  $.ajax({
    url: "/ajax/com/product/get-version",
    type: "POST",
    data: { product_id: product_id },
    dataType: "json",
    async: false,
    success: function (data) {
      for (let i = 0; i < data.length; i++) {
        $select22.append(`<option data-price="${data[i].price}"value="${data[i].version_no}">${data[i].version_name}</option>`);
      }
      if (JSON.stringify(params) !== "{}") {
        var $select22_select2 = $select22.select2();
        $select22_select2.val(params.variant).trigger("change");
      }
    },
  });
}
if (JSON.stringify(params) !== "{}") {
  $("input[name='dp']").attr("value", params.dp);
}
$select21.change(function () {
  $select22.empty().append("<option value=''></option>");
  var $this = $(this);
  var product_id = $this.val();
  $("input[name='model_name']").val($this.children("option:selected").text());
  getProduct(product_id);
});
$select22.change(function () {
  var $this = $(this);
  $.ajax({
    url: "/ajax/com/product/get-image",
    type: "POST",
    data: { product_id: $select21.val(), version_no: $this.val() },
    dataType: "json",
    async: false,
    success: function (data) {
      if (data) {
        $("input[name='image']").val(data[0].model_image);
      }
    },
  });
  $("input[name='product_name']").val($this.children("option:selected").text());
  $("input[name='price']").val($this.children("option:selected").data("price"));
});
if ($select23_holder.is(":selected")) {
  $select23.addClass("select-placeholder");
}
$select23.change(function () {
  if (!$select23_holder.is(":selected")) {
    $select23.removeClass("select-placeholder");
  }
});
$select23.click(function (e) {
  if ($select_section.hasClass("select-section-open")) {
    $select_section.removeClass("select-section-open");
  } else {
    $select_section.addClass("select-section-open");
  }
  e.stopPropagation();
});
$("body").click(function () {
  $select_section.removeClass("select-section-open");
});
var error_msg = $(`<div class="errMsg"style="color:#de2622;margin-left:20px;"><strong>Kolom wajib diisi.</strong></div>`);
var input_arr = ["dp"];
var select_arr = ["model", "variant", "period"];
var all_arr = [...input_arr, ...select_arr];
function check() {
  var hasError = false;
  all_arr.forEach((item) => {
    if (input_arr.includes(item)) {
      var target = $(`input[name='${item}']`);
      var target_parent = target.parent().parent();
    } else if (select_arr.includes(item)) {
      var target = $(`select[name='${item}']`);
      var target_parent = target.parent();
    }
    if (target_parent.hasClass("error")) {
      target_parent.children(".errMsg").remove();
    }
    if (target.val() == "") {
      if (select_arr.includes(item)) {
        target.before(error_msg.clone());
      } else {
        target.parent().before(error_msg.clone());
      }
      target_parent.addClass("error");
      hasError = true;
    } else {
      target_parent.removeClass("error");
    }
  });
  if (hasError) return false;
  $(".submit-btn").parents("form").submit();
}
